<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Digital Signage Player</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root { 
      --font-scale: 1;
      --header-gap: 2.5vh; 
      --header-pad-y: 2.2vh;
      --theme-bg: #0a0a0a;
      --theme-header-bg: rgba(0,0,0,0.3);
      --theme-accent: #f77436;
      --theme-event-text: #ffffff;
      --theme-time-text: #dddddd;
      --theme-room-text: #cccccc;
      --theme-live-badge: #f77436;
      --theme-live-bg: rgba(31,18,10,0.8);
      --theme-progress: #f77436;
      --theme-ticker-bg: rgba(11,11,11,0.95);
      --theme-ticker-text: #dddddd;
    }
    
    * {
      -webkit-transform: translateZ(0);
      -webkit-backface-visibility: hidden;
    }

    html, body {
      margin: 0;
      padding: 0;
      width: 100vw;
      height: 100vh;
      background: var(--theme-bg);
      color: var(--theme-event-text);
      font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, Roboto, Arial, sans-serif;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    
    .safe { 
      padding: 1.5vh 2vw 4vh; 
      box-sizing: border-box; 
      width: 100%; 
    }
    
    #header {
      display: none;
      grid-template-columns: 1fr auto;
      align-items: center;
      gap: 2vw;
      border-bottom: 0.4vh solid rgba(255,255,255,0.1);
      background: var(--theme-header-bg);
      position: relative;
      z-index: 100;
      width: 100%;
      min-height: 9vh;
      box-sizing: border-box;
    }
    
    #header-left {
      display: flex;
      align-items: center;
      gap: 1.5vw;
      flex: 1 1 auto;
      min-width: 0;
    }
    
    #header-logo {
      height: 9.5vh;
      width: auto;
      max-width: 25vh;
      border-radius: 1vh;
      background: #fff;
      object-fit: contain;
      padding: 0.8vh;
      box-sizing: border-box;
      display: none;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      flex-shrink: 0;
    }
    
    #rink-title {
      flex: 1 1 auto;
      min-width: 0;
      font-size: calc(4.6vh * var(--font-scale));
      font-weight: 700;
      letter-spacing: 0.25vh;
      text-transform: uppercase;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: var(--theme-event-text);
      line-height: 1.05;
    }
    
    #clock {
      font-size: calc(4.5vh * var(--font-scale));
      color: var(--theme-time-text);
      white-space: nowrap;
      text-align: right;
      font-weight: 700;
      letter-spacing: 0.2vh;
      line-height: 1;
      justify-self: end;
      min-width: max-content;
    }

    /* Pairing screen - Samsung style */
    #code-screen { 
      flex: 1; 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      justify-content: center; 
      text-align: center; 
      gap: 5vh; 
      background: linear-gradient(135deg, #3d5875 0%, #2c3e50 100%);
      padding: 4vh 2vw;
    }
    
    #code-screen h1 { 
      font-size: calc(4.5vh * var(--font-scale)); 
      margin: 0; 
      font-weight: 400; 
      color: #e8edf2;
      letter-spacing: 0.05vh;
    }
    
    #screen-code { 
      font-size: calc(12vh * var(--font-scale)); 
      font-weight: 700; 
      background: transparent;
      padding: 0; 
      border-radius: 0; 
      letter-spacing: 2.5vh; 
      box-shadow: none;
      border: none; 
      color: #3dd9eb;
      text-shadow: 0 0 30px rgba(61, 217, 235, 0.4);
      margin: 2vh 0;
    }
    
    .pairing-instructions {
      background: rgba(30, 40, 55, 0.7);
      padding: 3vh 4vh;
      border-radius: 1.5vh;
      max-width: 700px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }
    
    .pairing-step {
      display: flex;
      align-items: flex-start;
      gap: 2vh;
      margin-bottom: 2.5vh;
      text-align: left;
    }
    
    .pairing-step:last-child {
      margin-bottom: 0;
    }
    
    .step-number {
      font-size: calc(2.2vh * var(--font-scale));
      font-weight: 700;
      color: #95a5a6;
      min-width: 8vh;
      flex-shrink: 0;
    }
    
    .step-text {
      font-size: calc(2.2vh * var(--font-scale));
      color: #d5dce3;
      line-height: 1.6;
      padding-top: 0.1vh;
    }
    
    .step-url {
      color: #3dd9eb;
      text-decoration: none;
      word-break: break-all;
      display: block;
      margin-top: 0.5vh;
    }
    
    .platform-info { 
      margin-top: 2vh; 
      font-size: calc(2.2vh * var(--font-scale)); 
      color: #7f8c8d;
      font-weight: 400;
    }
    
    #realtime-status {
      position: fixed;
      top: 1vh;
      left: 1vw;
      padding: 0.5vh 1vw;
      border-radius: 1vh;
      font-size: calc(1.8vh * var(--font-scale));
      background: rgba(0,0,0,0.7);
      color: #aaa;
      z-index: 1000;
      display: none;
    }
    
    #realtime-status.connected {
      color: #19c37d;
      display: block;
    }
    
    #realtime-status.connecting {
      color: #ffa500;
      display: block;
    }
    
    #realtime-status.disconnected {
      color: #ff4444;
      display: block;
    }

    #event-screen { 
      display: none; 
      flex-direction: column; 
      height: 100%; 
    }
    
    .event-only { 
      position: relative; 
      flex: 1; 
      width: 100%; 
      padding: 0 3vw 8vh; 
      box-sizing: border-box; 
      font-size: calc(3.5vh * var(--font-scale)); 
      overflow-y: auto; 
      -webkit-overflow-scrolling: touch;
    }
    
    .event-header, .event-row { 
      display: flex; 
      padding: 2vh 1vw; 
      border-bottom: 0.4vh solid rgba(255,255,255,0.05); 
      align-items: center; 
    }
    
    .event-header { 
      position: sticky; 
      top: 0; 
      z-index: 10; 
      font-weight: 600; 
      background: rgba(13,13,13,0.95);
      color: #cfcfcf; 
      border-top: 0.4vh solid rgba(255,255,255,0.05); 
      box-shadow: 0 4px 20px rgba(0,0,0,0.3); 
    }
    
    .event-row { 
      color: var(--theme-event-text);
    }
    
    .event-row:nth-child(even) { 
      background: rgba(255,255,255,0.02); 
    }
    
    .event-cell { 
      flex: 1; 
      padding: 0 2vw; 
    }
    
    .event-cell.time { 
      text-align: center; 
      font-variant-numeric: tabular-nums; 
      color: var(--theme-time-text);
    }
    
    .event-cell.room { 
      text-align: right; 
      color: var(--theme-room-text);
    }

    .live { 
      background: var(--theme-live-bg);
      border-bottom-color: rgba(247,116,54,0.3); 
      font-weight: 700; 
    }
    
    .live .live-pill { 
      display: inline-block; 
      margin-left: 1vw; 
      font-size: calc(2.4vh * var(--font-scale)); 
      line-height: 1; 
      padding: 0.8vh 1.4vh; 
      background: var(--theme-live-badge);
      color: #1a0d08; 
      border-radius: 1.5vh; 
      vertical-align: middle; 
      font-weight: 700; 
      box-shadow: 0 2px 10px rgba(247,116,54,0.4); 
    }
    
    .progress { 
      height: 0.5vh; 
      background: rgba(26,26,26,0.8); 
      width: 100%; 
      border-radius: 0.25vh; 
      overflow: hidden; 
    }
    
    .progress-fill { 
      height: 100%; 
      background: var(--theme-progress);
      width: 0%; 
      -webkit-transition: width 1s ease-out;
      transition: width 1s ease-out; 
      box-shadow: 0 0 10px rgba(247,116,54,0.5); 
    }
    
    @keyframes fadeOutSlide {
      0% { 
        opacity: 1; 
        transform: translateX(0);
        max-height: 100px;
      }
      50% {
        opacity: 0;
        transform: translateX(-50px);
      }
      100% { 
        opacity: 0; 
        transform: translateX(-100px); 
        max-height: 0;
        padding: 0;
        border: 0;
      }
    }
    
    @keyframes pulseIn {
      0% { 
        transform: scale(0.98);
        opacity: 0.8;
      }
      50% {
        transform: scale(1.02);
      }
      100% { 
        transform: scale(1);
        opacity: 1;
      }
    }
    
    .event-row {
      transition: all 0.3s ease-out;
    }
    
    .event-row.expired {
      animation: fadeOutSlide 0.5s ease-out forwards;
    }

    #empty-screen { 
      display: none; 
      flex: 1; 
      align-items: center; 
      justify-content: center; 
      flex-direction: column; 
      gap: 3vh; 
      text-align: center; 
      padding: 0 2vw; 
      box-sizing: border-box; 
      background: rgba(255,255,255,0.02);
    }
    
    #empty-logo {
      height: 22vh;
      width: auto;
      max-width: 50vh;
      border-radius: 2vh;
      object-fit: contain;
      padding: 2vh;
      box-sizing: border-box;
      background: #fff;
      display: none;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    }
    
    #empty-title { 
      font-size: calc(4.6vh * var(--font-scale)); 
      font-weight: 600; 
      letter-spacing: 0.3vh; 
      text-transform: uppercase; 
      max-width: 90vw; 
      overflow: hidden; 
      text-overflow: ellipsis; 
      display: none; 
      color: var(--theme-event-text);
    }
    
    #empty-status { 
      font-size: calc(4vh * var(--font-scale)); 
      color: #bbb; 
      font-weight: 300; 
    }
    
    #empty-clock { 
      font-size: calc(3.6vh * var(--font-scale)); 
      color: var(--theme-time-text); 
      margin-top: 1.5vh; 
      font-weight: 300; 
    }

    #ticker { 
      height: 8vh;
      min-height: 60px;
      border-top: 0.4vh solid rgba(255,255,255,0.1); 
      background: var(--theme-ticker-bg);
      overflow: hidden; 
      box-shadow: 0 -4px 20px rgba(0,0,0,0.3); 
      display: flex;
      align-items: center;
      padding: 1vh 0;
    }
    
    #ticker-track { 
      position: relative; 
      white-space: nowrap; 
      will-change: transform; 
      line-height: 1.5;
      font-size: calc(4vh * var(--font-scale)); 
      color: var(--theme-ticker-text); 
      padding-left: 0; 
      -webkit-transform: translateX(0);
      transform: translateX(0); 
      font-weight: 400; 
    }

    #network-status { 
      position: fixed; 
      top: 1vh; 
      right: 1vw; 
      width: 12px; 
      height: 12px; 
      border-radius: 50%; 
      background: #19c37d; 
      z-index: 1000; 
    }
    
    #network-status.slow { 
      background: #ffa500; 
    }
    
    #network-status.offline { 
      background: #ff4444; 
    }
    
    #platform-indicator { 
      position: fixed; 
      bottom: 1vh; 
      right: 1vw; 
      font-size: calc(2vh * var(--font-scale)); 
      color: #666; 
      background: rgba(0,0,0,0.7); 
      padding: 0.5vh 1vw; 
      border-radius: 1vh; 
      z-index: 1000; 
    }

    .theme-preview-badge {
      position: fixed;
      top: 10px;
      right: 10px;
      background: var(--theme-accent);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      z-index: 10000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { opacity: 0.9; }
      50% { opacity: 1; }
      100% { opacity: 0.9; }
    }

    @media (max-width: 1200px) {
      #rink-title { font-size: calc(4.2vh * var(--font-scale)); }
      #clock { font-size: calc(3.4vh * var(--font-scale)); }
      .event-only { font-size: calc(3vh * var(--font-scale)); }
    }

    /* ==============================================
       COMBINED DISPLAY LAYOUTS
       ============================================== */

    #combined-display {
      display: none;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    #combined-display.active {
      display: grid;
    }

    /* 2-Up Vertical (Top/Bottom) */
    #combined-display.layout-2-up-vertical {
      grid-template-rows: 1fr 1fr;
      grid-template-columns: 1fr;
    }

    /* 2-Up Horizontal (Left/Right) */
    #combined-display.layout-2-up-horizontal {
      grid-template-rows: 1fr;
      grid-template-columns: 1fr 1fr;
    }

    /* 3-Up (One on top, two on bottom) */
    #combined-display.layout-3-up {
      grid-template-rows: 1fr 1fr;
      grid-template-columns: 1fr 1fr;
    }

    #combined-display.layout-3-up .rink-panel:first-child {
      grid-column: 1 / -1;
    }

    /* 4-Grid */
    #combined-display.layout-4-grid {
      grid-template-rows: 1fr 1fr;
      grid-template-columns: 1fr 1fr;
    }

    /* Individual Rink Panel */
    .rink-panel {
      display: flex;
      flex-direction: column;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.1);
      position: relative;
    }

    .rink-panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 2vh 2vw;
      background: var(--theme-header-bg);
      border-bottom: 0.3vh solid rgba(255,255,255,0.1);
      gap: 1.5vw;
      min-height: 9vh;
    }

    .rink-panel-header-left {
      display: flex;
      align-items: center;
      gap: 2.5vw;
      flex: 1;
      min-width: 0;
    }

    .rink-panel-logo {
      height: 6.5vh;
      width: auto;
      max-width: 14vh;
      border-radius: 0.5vh;
      background: #fff;
      object-fit: contain;
      padding: 0.5vh;
      box-sizing: border-box;
      display: none;
      flex-shrink: 0;
      margin-right: 2vw;
    }

    .rink-panel-title {
      font-size: calc(3.8vh * var(--font-scale));
      font-weight: 700;
      letter-spacing: 0.15vh;
      text-transform: uppercase;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: var(--theme-accent);
    }

    .rink-panel-clock {
      font-size: calc(3vh * var(--font-scale));
      color: var(--theme-time-text);
      white-space: nowrap;
      font-weight: 600;
    }

    .rink-panel-events {
      flex: 1;
      overflow-y: auto;
      padding: 0 1.5vw 2vh;
      font-size: calc(3vh * var(--font-scale));
    }

    .rink-panel .event-header {
      font-size: calc(2.4vh * var(--font-scale));
      padding: 1.5vh 1vw;
    }

    .rink-panel .event-row {
      font-size: calc(2.8vh * var(--font-scale));
      padding: 1.5vh 1vw;
    }

    .rink-panel .event-cell {
      padding: 0 1.2vw;
    }

    .rink-panel .live-pill {
      font-size: calc(2.2vh * var(--font-scale));
      padding: 0.6vh 1.2vh;
    }

    .rink-panel-empty {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      color: rgba(255,255,255,0.5);
      font-size: calc(2.8vh * var(--font-scale));
      gap: 1vh;
    }

    .rink-panel-empty-icon {
      font-size: calc(5vh * var(--font-scale));
      opacity: 0.4;
    }

    /* Hide normal screens when combined display is active */
    body.combined-mode #header,
    body.combined-mode #event-screen,
    body.combined-mode #empty-screen,
    body.combined-mode #code-screen {
      display: none !important;
    }

    body.combined-mode #ticker {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 100;
    }
  </style>
</head>
<body>
  <div id="network-status" title="Network Status"></div>
  <div id="realtime-status">‚óè</div>
  <div id="platform-indicator">Detecting...</div>
  
  <div id="header" class="safe">
    <div id="header-left">
      <img id="header-logo" alt="Logo">
      <div id="rink-title">Rink</div>
    </div>
    <div id="clock">‚Äî</div>
  </div>
  
  <div id="code-screen" class="safe">
    <h1>Pairing with Code</h1>
    <div id="screen-code">--------</div>
    
    <div class="pairing-instructions">
      <div class="pairing-step">
        <div class="step-number">STEP 1</div>
        <div class="step-text">
          Sign in to PostSignage dashboard:
          <span class="step-url">https://postsignage.com/dashboard</span>
        </div>
      </div>
      
      <div class="pairing-step">
        <div class="step-number">STEP 2</div>
        <div class="step-text">
          Select your rink from the dropdown menu.
        </div>
      </div>
      
      <div class="pairing-step">
        <div class="step-number">STEP 3</div>
        <div class="step-text">
          Enter the screen code above and click "Assign Screen Code".
        </div>
      </div>
    </div>
    
    <div class="platform-info" id="platform-info">Detecting platform...</div>
  </div>
  
  <div id="event-screen">
    <div class="event-only" id="events">Loading events...</div>
  </div>
  
  <div id="empty-screen">
    <img id="empty-logo" alt="Logo">
    <div id="empty-title"></div>
    <div id="empty-status">No events scheduled today</div>
    <div id="empty-clock">‚Äî</div>
  </div>

  <!-- Combined Display Container for Multi-Rink Layouts -->
  <div id="combined-display">
    <!-- Rink panels will be dynamically inserted here -->
  </div>

  <div id="ticker"><div id="ticker-track"></div></div>

  <script>
  (function(){
    var CONFIG = {
      POLL_INTERVAL: 60000,
      HEARTBEAT_INTERVAL: 30000,
      PROGRESS_UPDATE_INTERVAL: 2000,
      DEFAULT_EVENT_DURATION: 90,
      FORCE_12H_CLOCK: true,
      API_TIMEOUT: 8000,
      CACHE_TTL: 86400000,
      RETRY_DELAYS: [1000, 2000, 4000, 8000],
      SCROLL: {
        SPEED: 1,
        INTERVAL: 30,
        PAUSE_TOP: 1500,
        PAUSE_BOTTOM: 3000
      },
      TICKER_SPEED: 100
    };
    
    var state = {
      screenCode: '',
      lastPayload: null,
      lastSignature: null,
      networkFailures: 0,
      retryCount: 0,
      userInteracting: false,
      scrollTimer: null,
      scrollPause: null,
      pollHandle: null,
      isRegistered: false,
      lastSuccessfulData: null,
      currentTheme: null,
      combinedLayout: null,
      combinedRinks: []
    };

    var supabaseClient = null;
    var realtimeChannel = null;
    var currentRinkId = null;
    
    function initSupabase() {
      if (typeof window.supabase === 'undefined') {
        console.log('Supabase library not loaded, realtime disabled');
        return;
      }
      
      try {
        supabaseClient = window.supabase.createClient(
          'https://excfbqwqzryjlsrgfpjm.supabase.co',
          'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV4Y2ZicXdxenJ5amxzcmdmcGptIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM4NzMwNzMsImV4cCI6MjA2OTQ0OTA3M30.OdYAso9j7j4VIefQ76nI0TSoFtqJIUYcAtX5P9KYf8M'
        );
        console.log('Supabase initialized successfully');
        updateRealtimeStatus('disconnected');
      } catch(e) {
        console.log('Failed to initialize Supabase:', e);
      }
    }
    
    function updateRealtimeStatus(status) {
      var indicator = document.getElementById('realtime-status');
      if (!indicator) return;
      
      indicator.className = status;
      switch(status) {
        case 'connected':
          indicator.textContent = 'Live';
          break;
        case 'connecting':
          indicator.textContent = 'Connecting...';
          break;
        case 'disconnected':
          indicator.textContent = 'Offline';
          break;
      }
    }
    
    function subscribeToRealtime(rinkId) {
      if (!supabaseClient || !rinkId) {
        console.log('Cannot subscribe: missing supabaseClient or rinkId');
        return;
      }
      
      if (realtimeChannel) {
        console.log('Removing existing channel subscription');
        supabaseClient.removeChannel(realtimeChannel);
        realtimeChannel = null;
      }
      
      currentRinkId = rinkId;
      console.log('Subscribing to realtime updates for rink:', rinkId);
      updateRealtimeStatus('connecting');
      
      realtimeChannel = supabaseClient
        .channel('rink-updates-' + rinkId)
        .on(
          'postgres_changes',
          {
            event: '*',
            schema: 'public',
            table: 'bookings',
            filter: 'rink_id=eq.' + rinkId
          },
          function(payload) {
            console.log('Booking update received:', payload.eventType);
            checkAndLoadEvents();
          }
        )
        .on(
          'postgres_changes',
          {
            event: 'UPDATE',
            schema: 'public',
            table: 'rinks',
            filter: 'id=eq.' + rinkId
          },
          function(payload) {
            console.log('Rink update received:', payload.eventType);
            checkAndLoadEvents();
          }
        )
        .subscribe(function(status) {
          console.log('Realtime subscription status:', status);
          if (status === 'SUBSCRIBED') {
            updateRealtimeStatus('connected');
            console.log('Successfully subscribed to realtime updates');
          } else if (status === 'CHANNEL_ERROR') {
            updateRealtimeStatus('disconnected');
            console.log('Realtime subscription error');
          } else if (status === 'TIMED_OUT') {
            updateRealtimeStatus('disconnected');
            console.log('Realtime subscription timed out');
          }
        });
    }

    function applyTheme(theme) {
      if (!theme) return;
      
      var themeStyle = document.getElementById('custom-theme');
      if (!themeStyle) {
        themeStyle = document.createElement('style');
        themeStyle.id = 'custom-theme';
        document.head.appendChild(themeStyle);
      }
      
      themeStyle.textContent = `
        :root {
          --theme-bg: ${theme.bg_color || '#0a0a0a'};
          --theme-header-bg: ${theme.header_bg || 'rgba(0,0,0,0.3)'};
          --theme-accent: ${theme.accent || '#f77436'};
          --theme-event-text: ${theme.event_text || '#ffffff'};
          --theme-time-text: ${theme.time_text || '#dddddd'};
          --theme-room-text: ${theme.room_text || '#cccccc'};
          --theme-live-badge: ${theme.live_badge || '#f77436'};
          --theme-live-bg: ${theme.live_bg || 'rgba(31,18,10,0.8)'};
          --theme-progress: ${theme.progress_bar || '#f77436'};
          --theme-ticker-bg: ${theme.ticker_bg || 'rgba(11,11,11,0.95)'};
          --theme-ticker-text: ${theme.ticker_text || '#dddddd'};
        }
      `;
    }

    function applyFontScale(scale) {
      if (!scale || scale === 1.0) {
        document.documentElement.style.setProperty('--font-scale', '1');
        return;
      }

      document.documentElement.style.setProperty('--font-scale', scale);
    }

    // ==============================================
    // COMBINED DISPLAY FUNCTIONS
    // ==============================================

    function checkCombinedLayout(rinkData) {
      if (!rinkData) return false;

      var layout = rinkData.layout || 'single';
      if (layout === 'single') return false;

      // Check if we have the required slot rinks
      var hasSlotB = !!rinkData.slot_b_rink_id;
      var hasSlotC = !!rinkData.slot_c_rink_id;
      var hasSlotD = !!rinkData.slot_d_rink_id;

      if (layout === '2-up-vertical' || layout === '2-up-horizontal') {
        return hasSlotB;
      } else if (layout === '3-up') {
        return hasSlotB && hasSlotC;
      } else if (layout === '4-grid') {
        return hasSlotB && hasSlotC && hasSlotD;
      }

      return false;
    }

    async function fetchLayoutSettings(rinkId) {
      if (!supabaseClient || !rinkId) return null;

      try {
        var result = await supabaseClient
          .from('rinks')
          .select('layout, slot_b_rink_id, slot_c_rink_id, slot_d_rink_id')
          .eq('id', rinkId)
          .single();

        if (result.error || !result.data) return null;

        return result.data;
      } catch (e) {
        console.log('Error fetching layout settings:', e);
        return null;
      }
    }

    async function checkAndLoadCombinedIfNeeded(data) {
      if (!data || !data.rink_id) return false;

      // Check if API already provided combined_rinks data (preferred method)
      if (data.combined_rinks && Array.isArray(data.combined_rinks) && data.combined_rinks.length > 1) {
        console.log('>>> LOADING COMBINED DISPLAY (from API)');
        console.log('Layout:', data.layout);
        console.log('Combined rinks count:', data.combined_rinks.length);

        state.combinedLayout = data.layout;
        state.combinedRinks = data.combined_rinks;

        renderCombinedDisplay(data.layout, data.combined_rinks);
        return true;
      }

      // Fallback: Fetch layout settings from database if API didn't provide combined_rinks
      if (!supabaseClient) return false;

      var layoutSettings = await fetchLayoutSettings(data.rink_id);

      if (!layoutSettings || !layoutSettings.layout || layoutSettings.layout === 'single') {
        return false;
      }

      // Merge layout settings into data
      data.layout = layoutSettings.layout;
      data.slot_b_rink_id = layoutSettings.slot_b_rink_id;
      data.slot_c_rink_id = layoutSettings.slot_c_rink_id;
      data.slot_d_rink_id = layoutSettings.slot_d_rink_id;

      if (checkCombinedLayout(data)) {
        console.log('>>> LOADING COMBINED DISPLAY (fallback method)');
        return await loadCombinedDisplay(data);
      }

      return false;
    }

    async function fetchRinkData(rinkId) {
      if (!rinkId) return null;

      try {
        // First, get the screen_code for this rink_id so we can use the API
        // Try to get screen_code from Supabase first
        var screenCode = null;

        if (supabaseClient) {
          try {
            var codeResult = await supabaseClient
              .from('rinks')
              .select('screen_code')
              .eq('id', rinkId)
              .maybeSingle();  // Use maybeSingle to avoid 406 on no results

            if (codeResult.data && codeResult.data.screen_code) {
              screenCode = codeResult.data.screen_code;
            }
          } catch (e) {
            console.log('Could not fetch screen_code from Supabase:', e);
          }
        }

        // If we got a screen_code, use the API endpoint
        if (screenCode) {
          return new Promise(function(resolve) {
            var apiUrl = 'https://post-signage-api.abdullaafraz.workers.dev?id=' +
                         encodeURIComponent(screenCode);

            var xhr = new XMLHttpRequest();
            xhr.open('GET', apiUrl, true);
            xhr.setRequestHeader('Cache-Control', 'no-cache');
            xhr.timeout = CONFIG.API_TIMEOUT;

            xhr.onreadystatechange = function() {
              if (xhr.readyState === 4) {
                if (xhr.status >= 200 && xhr.status < 300) {
                  try {
                    var data = JSON.parse(xhr.responseText);
                    if (data && data.registered) {
                      resolve({
                        rink_id: data.rink_id,
                        rink_title: data.rink_title,
                        rink_logo: data.rink_logo,
                        ticker_text: data.ticker_text || data.announcement || '',
                        events: data.events || [],
                        theme: data.theme || null,
                        font_scale: data.font_scale
                      });
                    } else {
                      resolve(null);
                    }
                  } catch (e) {
                    console.log('Error parsing rink API response:', e);
                    resolve(null);
                  }
                } else {
                  console.log('API request failed with status:', xhr.status);
                  resolve(null);
                }
              }
            };

            xhr.onerror = function() {
              console.log('API request error');
              resolve(null);
            };

            xhr.ontimeout = function() {
              console.log('API request timeout');
              resolve(null);
            };

            xhr.send(null);
          });
        }

        // Fallback: Try direct Supabase query if no screen_code
        // This may fail due to RLS but we'll try anyway
        if (supabaseClient) {
          var rinkResult = await supabaseClient
            .from('rinks')
            .select('id, name, screen_code, logo_url, ticker_text, theme_bg_color, theme_header_bg, theme_accent, theme_event_text, theme_time_text, theme_room_text, theme_live_badge, theme_live_bg, theme_progress_bar, font_scale')
            .eq('id', rinkId)
            .maybeSingle();  // Use maybeSingle to avoid 406

          if (rinkResult.error || !rinkResult.data) {
            console.log('Supabase rink query failed:', rinkResult.error);
            return null;
          }

          var rink = rinkResult.data;

          // Get today's bookings
          var today = new Date();
          var todayStr = today.getFullYear() + '-' +
                         String(today.getMonth() + 1).padStart(2, '0') + '-' +
                         String(today.getDate()).padStart(2, '0');

          var bookingsResult = await supabaseClient
            .from('bookings')
            .select('*')
            .eq('rink_id', rinkId)
            .eq('date', todayStr)
            .order('start_time', { ascending: true });

          var events = [];
          if (!bookingsResult.error && bookingsResult.data) {
            events = bookingsResult.data.map(function(b) {
              return {
                teams: b.teams,
                room: b.room,
                start_time: b.start_time,
                end_time: b.end_time,
                date: b.date
              };
            });
          }

          // Get active announcements
          var now = new Date().toISOString();
          var announcementsResult = await supabaseClient
            .from('announcements')
            .select('message, priority')
            .or('rink_id.eq.' + rinkId + ',rink_id.is.null')
            .lte('start_time', now)
            .gte('end_time', now)
            .order('priority', { ascending: false })
            .limit(1);

          var ticker = '';
          if (!announcementsResult.error && announcementsResult.data && announcementsResult.data.length > 0) {
            ticker = announcementsResult.data[0].message;
          } else if (rink.ticker_text) {
            ticker = rink.ticker_text;
          }

          return {
            rink_id: rink.id,
            rink_title: rink.name,
            rink_logo: rink.logo_url,
            ticker_text: ticker,
            events: events,
            theme: {
              bg_color: rink.theme_bg_color,
              header_bg: rink.theme_header_bg,
              accent: rink.theme_accent,
              event_text: rink.theme_event_text,
              time_text: rink.theme_time_text,
              room_text: rink.theme_room_text,
              live_badge: rink.theme_live_badge,
              live_bg: rink.theme_live_bg,
              progress_bar: rink.theme_progress_bar
            },
            font_scale: rink.font_scale
          };
        }

        return null;
      } catch (e) {
        console.log('Error fetching rink data:', e);
        return null;
      }
    }

    async function loadCombinedDisplay(primaryData) {
      var layout = primaryData.layout;
      var rinkIds = [primaryData.rink_id];

      // Add slot rinks based on layout
      if (primaryData.slot_b_rink_id) rinkIds.push(primaryData.slot_b_rink_id);
      if ((layout === '3-up' || layout === '4-grid') && primaryData.slot_c_rink_id) {
        rinkIds.push(primaryData.slot_c_rink_id);
      }
      if (layout === '4-grid' && primaryData.slot_d_rink_id) {
        rinkIds.push(primaryData.slot_d_rink_id);
      }

      console.log('=== COMBINED DISPLAY ===');
      console.log('Layout:', layout);
      console.log('Primary rink ID:', primaryData.rink_id);
      console.log('All rink IDs to load:', rinkIds);

      // Fetch data for all rinks
      var rinkDataArray = [];

      // First rink uses primaryData (already have it)
      rinkDataArray.push({
        rink_id: primaryData.rink_id,
        rink_title: primaryData.rink_title,
        rink_logo: primaryData.rink_logo,
        ticker_text: primaryData.ticker_text,
        events: primaryData.events,
        theme: primaryData.theme,
        font_scale: primaryData.font_scale
      });
      console.log('Primary rink loaded:', primaryData.rink_title);

      // Fetch additional rinks
      for (var i = 1; i < rinkIds.length; i++) {
        console.log('Fetching secondary rink:', rinkIds[i]);
        var rinkData = await fetchRinkData(rinkIds[i]);
        if (rinkData) {
          console.log('Secondary rink loaded:', rinkData.rink_title);
          rinkDataArray.push(rinkData);
        } else {
          console.log('Failed to load secondary rink:', rinkIds[i]);
          // Still show a placeholder panel for missing rinks
          rinkDataArray.push({
            rink_id: rinkIds[i],
            rink_title: 'Loading...',
            rink_logo: null,
            ticker_text: '',
            events: [],
            theme: null,
            font_scale: 1
          });
        }
      }

      console.log('Total rinks loaded:', rinkDataArray.length);

      state.combinedLayout = layout;
      state.combinedRinks = rinkDataArray;

      renderCombinedDisplay(layout, rinkDataArray);
      return true;
    }

    function renderCombinedDisplay(layout, rinkDataArray) {
      var container = document.getElementById('combined-display');
      if (!container) return;

      // Clear existing content
      container.innerHTML = '';
      container.className = 'active layout-' + layout;

      // Add body class for combined mode
      document.body.classList.add('combined-mode');

      // Collect all ticker text
      var allTickers = [];

      // Create panel for each rink
      for (var i = 0; i < rinkDataArray.length; i++) {
        var rinkData = rinkDataArray[i];
        var panel = createRinkPanel(rinkData, i);
        container.appendChild(panel);

        if (rinkData.ticker_text) {
          allTickers.push(rinkData.rink_title + ': ' + rinkData.ticker_text);
        }
      }

      // Update ticker with combined announcements
      var combinedTicker = allTickers.join('     ‚Ä¢     ');
      updateTickerText(combinedTicker);

      // Show the combined display
      hide('code-screen');
      hide('header');
      hide('event-screen');
      hide('empty-screen');
    }

    function createRinkPanel(rinkData, index) {
      var panel = document.createElement('div');
      panel.className = 'rink-panel';
      panel.id = 'rink-panel-' + index;

      var now = new Date();
      var events = filterActiveEvents(rinkData.events || [], now);

      // Panel header
      var header = document.createElement('div');
      header.className = 'rink-panel-header';

      var headerLeft = document.createElement('div');
      headerLeft.className = 'rink-panel-header-left';

      if (rinkData.rink_logo) {
        var logo = document.createElement('img');
        logo.className = 'rink-panel-logo';
        logo.src = rinkData.rink_logo;
        logo.style.display = 'block';
        logo.onerror = function() { this.style.display = 'none'; };
        headerLeft.appendChild(logo);
      }

      var title = document.createElement('div');
      title.className = 'rink-panel-title';
      title.textContent = rinkData.rink_title || 'Rink';
      if (rinkData.theme && rinkData.theme.accent) {
        title.style.color = rinkData.theme.accent;
      }
      headerLeft.appendChild(title);

      header.appendChild(headerLeft);

      // Add clock to panel header (only on first panel to avoid duplication)
      if (index === 0) {
        var clock = document.createElement('div');
        clock.className = 'rink-panel-clock';
        clock.id = 'combined-clock';
        clock.textContent = fmtClock(new Date());
        header.appendChild(clock);
      }

      panel.appendChild(header);

      // Events container
      if (events.length > 0) {
        var eventsContainer = document.createElement('div');
        eventsContainer.className = 'rink-panel-events';

        var html = '<div class="event-header">'
                 + '<div class="event-cell">Event</div>'
                 + '<div class="event-cell time">Time</div>'
                 + '<div class="event-cell room">Room</div>'
                 + '</div>';

        for (var j = 0; j < events.length; j++) {
          var ev = events[j];
          var teams = esc(ev.teams || '');
          var startRaw = ev.start_time || '';
          var endRaw = ev.end_time || '';
          var room = esc(ev.room || '');

          var timeStr = '';
          if (startRaw || endRaw) {
            var a = to12h(startRaw);
            var b = to12h(endRaw);
            timeStr = a && b ? (a + ' - ' + b) : (a || b);
          }

          var times = getEventTimes(ev);
          var isLive = false;

          if (times.start) {
            var n = now.getTime();
            var s = times.start.getTime();
            var e = times.end ? times.end.getTime() : null;

            if (n >= s && (e === null || n < e)) {
              isLive = true;
            }
          }

          html += '<div class="event-row' + (isLive ? ' live' : '') + '">'
               + '<div class="event-cell">' + teams + (isLive ? ' <span class="live-pill">LIVE</span>' : '') + '</div>'
               + '<div class="event-cell time">' + timeStr + '</div>'
               + '<div class="event-cell room">' + room + '</div>'
               + '</div>';
        }

        eventsContainer.innerHTML = html;
        panel.appendChild(eventsContainer);
      } else {
        var emptyDiv = document.createElement('div');
        emptyDiv.className = 'rink-panel-empty';
        emptyDiv.innerHTML = '<div class="rink-panel-empty-icon">üìÖ</div>'
                           + '<div>No events scheduled</div>';
        panel.appendChild(emptyDiv);
      }

      return panel;
    }

    function filterActiveEvents(events, now) {
      var filtered = [];

      for (var i = 0; i < events.length; i++) {
        var ev = events[i];
        var times = getEventTimes(ev);

        if (!times.start && !times.end) continue;
        if (times.end && now.getTime() >= times.end.getTime()) continue;

        ev.__start = times.start ? times.start.getTime() : Number.MAX_SAFE_INTEGER;
        ev.__times = times;
        filtered.push(ev);
      }

      filtered.sort(function(a, b) {
        return a.__start - b.__start;
      });

      return filtered.slice(0, 10); // Limit to 10 events per panel
    }

    function updateCombinedDisplay() {
      if (!state.combinedLayout || !state.combinedRinks || state.combinedRinks.length === 0) return;

      // Re-render panels with updated time/live status
      var container = document.getElementById('combined-display');
      if (!container) return;

      container.innerHTML = '';

      for (var i = 0; i < state.combinedRinks.length; i++) {
        var panel = createRinkPanel(state.combinedRinks[i], i);
        container.appendChild(panel);
      }
    }

    function loadCachedTheme() {
      var cachedTheme = getCacheWithExpiry('theme_' + state.screenCode);
      if (cachedTheme) {
        applyTheme(cachedTheme);
      }
    }

    function isPreviewMode() {
      var params = new URLSearchParams(window.location.search);
      return params.get('preview') === 'true';
    }

    function applyPreviewTheme() {
      var params = new URLSearchParams(window.location.search);
      if (params.get('preview') !== 'true') return;
      
      var theme = {
        bg_color: params.get('bg') || '#0a0a0a',
        header_bg: params.get('header') || 'rgba(0,0,0,0.3)',
        accent: params.get('accent') || '#f77436',
        event_text: params.get('event') || '#ffffff',
        time_text: params.get('time') || '#dddddd',
        room_text: params.get('room') || '#cccccc',
        live_badge: params.get('badge') || '#f77436',
        live_bg: 'rgba(31,18,10,0.8)',
        progress_bar: params.get('progress') || '#f77436',
        ticker_bg: 'rgba(11,11,11,0.95)',
        ticker_text: params.get('time') || '#dddddd'
      };
      
      applyTheme(theme);
      
      var badge = document.createElement('div');
      badge.className = 'theme-preview-badge';
      badge.textContent = 'THEME PREVIEW';
      document.body.appendChild(badge);
      
      var sampleData = {
        registered: true,
        rink_title: 'Preview Arena',
        rink_logo: '',
        ticker_text: 'This is a preview of your custom theme ‚Ä¢ Helmets required ‚Ä¢ Public skate 7 PM',
        events: [
          {
            teams: 'Hawks vs Eagles',
            room: 'Main Rink',
            start_time: '09:00',
            end_time: '10:30',
            date: new Date().toISOString().split('T')[0]
          },
          {
            teams: 'Junior Practice',
            room: 'Practice Ice',
            start_time: '10:45',
            end_time: '11:45',
            date: new Date().toISOString().split('T')[0]
          },
          {
            teams: 'Figure Skating',
            room: 'Main Rink',
            start_time: '12:00',
            end_time: '13:00',
            date: new Date().toISOString().split('T')[0]
          }
        ],
        theme: theme
      };
      
      var now = new Date();
      var currentHour = now.getHours();
      if (currentHour >= 9 && currentHour < 18) {
        sampleData.events[0].start_time = pad2(currentHour) + ':00';
        sampleData.events[0].end_time = pad2(currentHour + 1) + ':30';
      }
      
      renderFromPayload(sampleData);
    }
    
    if (!window.requestAnimationFrame) {
      window.requestAnimationFrame = window.webkitRequestAnimationFrame || 
                                     window.mozRequestAnimationFrame || 
                                     function(cb){ setTimeout(cb, 1000/60); };
    }
    
    function parseQuery(){ 
      var out = {}; 
      try{ 
        var q = (location.search || '').replace(/^\?/, ''); 
        if (!q) return out; 
        var parts = q.split('&'); 
        for (var i = 0; i < parts.length; i++){ 
          var kv = parts[i].split('='); 
          if (!kv[0]) continue; 
          var k = decodeURIComponent(kv[0]); 
          var v = kv.length > 1 ? decodeURIComponent(kv[1].replace(/\+/g, ' ')) : ''; 
          out[k] = v; 
        } 
      } catch(e){
        console.log('parseQuery error:', e);
      } 
      return out; 
    }
    
    function getLocal(k){ 
      try{ 
        return localStorage ? localStorage.getItem(k) : null; 
      } catch(e){ 
        return null; 
      } 
    }
    
    function setLocal(k, v){ 
      try{ 
        if (localStorage) localStorage.setItem(k, v); 
      } catch(e){} 
    }
    
    function getCacheWithExpiry(key) {
      try {
        var item = getLocal(key);
        if (!item) return null;
        var parsed = JSON.parse(item);
        if (Date.now() > parsed.expiry) {
          localStorage.removeItem(key);
          return null;
        }
        return parsed.data;
      } catch(e) {
        return null;
      }
    }
    
    function setCacheWithExpiry(key, data) {
      try {
        var item = {
          data: data,
          expiry: Date.now() + CONFIG.CACHE_TTL
        };
        setLocal(key, JSON.stringify(item));
      } catch(e) {}
    }
    
    function getRegistrationStatus() {
      var status = getLocal('registration_status_' + state.screenCode);
      return status === 'true';
    }
    
    function setRegistrationStatus(registered) {
      state.isRegistered = registered;
      setLocal('registration_status_' + state.screenCode, registered ? 'true' : 'false');
    }
    
    var ESC_MAP = {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'};
    function esc(s){ 
      s = String(s == null ? '' : s); 
      return s.replace(/[&<>"']/g, function(c){ 
        return ESC_MAP[c] || c; 
      }); 
    }
    
    function pad2(n){ 
      return (n < 10 ? '0' : '') + n; 
    }
    
    function show(id){ 
      var el = document.getElementById(id); 
      if (!el) return; 
      var disp = (id === 'code-screen' || id === 'empty-screen') ? 'flex' : 
                 (id === 'header' ? 'grid' : 'block'); 
      el.style.display = disp; 
    }
    
    function hide(id){ 
      var el = document.getElementById(id); 
      if (el) el.style.display = 'none'; 
    }
    
    function detectPlatform() {
      var ua = navigator.userAgent.toLowerCase();
      var platform = '';
      
      if (ua.indexOf('webos') !== -1 || ua.indexOf('netcast') !== -1 || window.PalmServiceBridge) {
        platform = 'LG webOS Smart TV';
      } else if (ua.indexOf('tizen') !== -1 || window.tizen) {
        platform = 'Samsung Tizen Smart TV';
      } else if (ua.indexOf('android tv') !== -1 || ua.indexOf('googletv') !== -1) {
        platform = 'Android TV';
      } else if (ua.indexOf('chrome') !== -1) {
        platform = 'Chrome Browser';
      } else {
        platform = 'Web Browser';
      }
      
      var el1 = document.getElementById('platform-indicator');
      var el2 = document.getElementById('platform-info');
      if (el1) el1.textContent = platform;
      if (el2) el2.textContent = platform;
    }
    
    function getOrCreateScreenCode(){
      var q = parseQuery();
      var code = q.code || getLocal('screen_uuid');
      
      if (!code){
        var crypto = window.crypto || window.msCrypto;
        if (crypto && crypto.getRandomValues) {
          var arr = new Uint8Array(16);
          crypto.getRandomValues(arr);
          
          code = Array.from(arr, function(byte) {
            return ('0' + byte.toString(16)).slice(-2);
          }).join('').slice(0, 8).toUpperCase();
        } else {
          var timestamp = Date.now();
          var random = Math.random() * 0x100000000;
          var combined = (timestamp + random).toString(16);
          code = combined.slice(-8).toUpperCase();
          
          var chars = '0123456789ABCDEF';
          for (var i = 0; i < 8; i++) {
            if (Math.random() < 0.3) {
              var pos = Math.floor(Math.random() * 8);
              code = code.substr(0, pos) + chars[Math.floor(Math.random() * 16)] + code.substr(pos + 1);
            }
          }
        }
      }
      
      code = String(code).replace(/\s+/g, '').toUpperCase();
      setLocal('screen_uuid', code);
      state.screenCode = code;
      return code;
    }
    
    var networkStatus = document.getElementById('network-status');
    var net = {failures: 0, lastSuccess: Date.now(), responseTime: 0};
    
    function updateNetworkStatus(status, rt){
      if (!networkStatus) return;
      
      if (status === 'success'){
        net.failures = 0; 
        net.lastSuccess = Date.now(); 
        net.responseTime = rt || 0;
        state.networkFailures = 0;
        
        if (rt < 2000){ 
          networkStatus.className = ''; 
          networkStatus.title = 'Connected'; 
        } else { 
          networkStatus.className = 'slow'; 
          networkStatus.title = 'Slow Connection'; 
        }
      } else {
        net.failures++;
        state.networkFailures++;
        
        if (net.failures < 3 && (Date.now() - net.lastSuccess) < 60000){ 
          networkStatus.className = 'slow'; 
          networkStatus.title = 'Connection Issues'; 
        } else { 
          networkStatus.className = 'offline'; 
          networkStatus.title = 'Connection Lost'; 
        }
      }
    }
    
    function format12(h, m){ 
      var ap = h >= 12 ? 'PM' : 'AM'; 
      h = h % 12; 
      if (h === 0) h = 12; 
      return h + ':' + pad2(m) + ' ' + ap; 
    }
    
    function to12h(input){
      var s = String(input || '').trim(); 
      if (!s) return '';
      
      var rng = s.split(/\s*[-]\s*/); 
      if (rng.length === 2) return to12h(rng[0]) + ' - ' + to12h(rng[1]);
      
      if (/^\d{4}-\d{2}-\d{2}T/.test(s)){ 
        var d = new Date(s); 
        if (!isNaN(d.getTime())) return format12(d.getHours(), d.getMinutes()); 
      }
      
      var m = s.replace(/\./g, '').replace(/\s+/g, ' ')
               .match(/^(\d{1,2})(?::(\d{2}))?(?::\d{2})?\s*(AM|PM)?$/i);
      if (m){ 
        var h = parseInt(m[1], 10);
        var mins = parseInt(m[2] || '0', 10);
        var ap = m[3] ? m[3].toUpperCase() : null; 
        if (ap){ 
          if (ap === 'PM' && h < 12) h += 12; 
          if (ap === 'AM' && h === 12) h = 0; 
        } 
        return format12(h, mins); 
      }
      
      return s;
    }
    
    function parseTimeToDate(t){
      if (!t) return null; 
      var s = String(t).trim();
      
      if (/^\d{4}-\d{2}-\d{2}T/.test(s)){ 
        var d = new Date(s); 
        return isNaN(d.getTime()) ? null : d; 
      }
      
      var m = s.replace(/\./g, '').replace(/\s+/g, ' ')
               .match(/^(\d{1,2})(?::(\d{2}))?(?::\d{2})?\s*(AM|PM)?$/i);
      if (m){ 
        var now = new Date(); 
        var h = parseInt(m[1], 10);
        var mins = parseInt(m[2] || '0', 10);
        var ap = m[3] ? m[3].toUpperCase() : null; 
        if (ap){ 
          if (ap === 'PM' && h < 12) h += 12; 
          if (ap === 'AM' && h === 12) h = 0; 
        } 
        return new Date(now.getFullYear(), now.getMonth(), now.getDate(), h, mins, 0, 0); 
      }
      
      var parts = s.split(/\s*[-‚Äì‚Äî]\s*/); 
      if (parts.length === 2) return parseTimeToDate(parts[0]);
      
      return null;
    }
    
    function getEventTimes(ev){
      var sRaw = ev && (ev.start_time || ev.startTime || ev.start || 
                 (ev.time && String(ev.time).split(/\s*[-‚Äì‚Äî]\s*/)[0]));
      var eRaw = ev && (ev.end_time || ev.endTime || ev.end || 
                 (ev.time && String(ev.time).split(/\s*[-‚Äì‚Äî]\s*/)[1]));
      
      var start = parseTimeToDate(sRaw);
      var end = parseTimeToDate(eRaw);
      
      if (start && !end){ 
        end = new Date(start.getTime() + CONFIG.DEFAULT_EVENT_DURATION * 60 * 1000); 
      }
      
      if (start && end && end.getTime() <= start.getTime()){ 
        end = new Date(end.getTime() + 24 * 60 * 60 * 1000); 
      }
      
      return {start: start, end: end};
    }
    
    var DAYS = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    var MONTHS = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    
    function fmtClock(d){ 
      var dow = DAYS[d.getDay()];
      var mon = MONTHS[d.getMonth()];
      var day = d.getDate();
      var h = d.getHours();
      var m = pad2(d.getMinutes()); 
      
      if (CONFIG.FORCE_12H_CLOCK){ 
        var ap = h >= 12 ? 'PM' : 'AM'; 
        var hh = h % 12; 
        if (hh === 0) hh = 12; 
        return dow + ', ' + mon + ' ' + day + ' ¬∑ ' + hh + ':' + m + ' ' + ap; 
      } 
      
      return dow + ', ' + mon + ' ' + day + ' ¬∑ ' + pad2(h) + ':' + m; 
    }
    
    function updateClock(){
      var now = new Date();
      var s = fmtClock(now);
      var el1 = document.getElementById('clock');
      if (el1) el1.textContent = s;
      var el2 = document.getElementById('empty-clock');
      if (el2) el2.textContent = s;
      var el3 = document.getElementById('combined-clock');
      if (el3) el3.textContent = s;
    }
    
    function buildApiUrl(){ 
      return 'https://post-signage-api.abdullaafraz.workers.dev?id=' + 
             encodeURIComponent(state.screenCode); 
    }
    
    function xhrGetWithRetry(url, ok, fail){
      var t0 = Date.now();
      
      function attempt() {
        try{
          var x = new XMLHttpRequest();
          x.open('GET', url, true);
          x.setRequestHeader('Cache-Control', 'no-cache');
          
          x.onreadystatechange = function(){
            if (x.readyState === 4){
              var dt = Date.now() - t0;
              
              if (x.status >= 200 && x.status < 300){ 
                updateNetworkStatus('success', dt); 
                state.retryCount = 0;
                ok && ok(x.responseText); 
              } else { 
                handleError(new Error('HTTP ' + x.status));
              }
            }
          };
          
          x.timeout = CONFIG.API_TIMEOUT;
          x.ontimeout = function(){ 
            handleError(new Error('timeout')); 
          };
          
          x.send(null);
        } catch(e){ 
          handleError(e);
        }
      }
      
      function handleError(e) {
        updateNetworkStatus('error');
        
        if (state.retryCount < CONFIG.RETRY_DELAYS.length) {
          var delay = CONFIG.RETRY_DELAYS[state.retryCount];
          state.retryCount++;
          setTimeout(attempt, delay);
        } else {
          fail && fail(e);
        }
      }
      
      attempt();
    }

    var TICKER = {text: '', x: 0, w: 0, holderW: 0, emptyStreak: 0, lastTime: 0, animFrame: null};
    
    function normalizeText(t){ 
      return String(t || '').replace(/\s+/g, ' ').trim(); 
    }
    
    function measureTicker(){ 
      var holder = document.getElementById('ticker');
      var track = document.getElementById('ticker-track'); 
      if (!holder || !track) return; 
      
      TICKER.holderW = holder.clientWidth || 1920; 
      var original = track.textContent; 
      
      if (TICKER.text && original !== TICKER.text) track.textContent = TICKER.text; 
      
      var rect = track.getBoundingClientRect(); 
      TICKER.w = rect.width || track.scrollWidth || track.offsetWidth || (TICKER.text.length * 12); 
    }
    
    function applyTicker(){ 
      var holder = document.getElementById('ticker');
      var track = document.getElementById('ticker-track'); 
      if (!holder || !track) return; 
      
      if (!TICKER.text){ 
        holder.style.display = 'none'; 
        return; 
      } 
      
      holder.style.display = 'block'; 
      track.textContent = TICKER.text; 
      measureTicker(); 
      
      if (TICKER.x === 0) TICKER.x = TICKER.holderW; 
      track.style.transform = 'translateX(' + Math.round(TICKER.x) + 'px)'; 
    }
    
    function updateTickerText(newText){ 
      var norm = normalizeText(newText); 
      
      if (!norm){ 
        if (TICKER.text){ 
          TICKER.emptyStreak++; 
          if (TICKER.emptyStreak <= 3) return; 
        } 
        TICKER.text = ''; 
        TICKER.emptyStreak = 0; 
        applyTicker(); 
        return; 
      } 
      
      TICKER.emptyStreak = 0; 
      if (norm === TICKER.text) return; 
      
      TICKER.text = norm; 
      applyTicker(); 
    }
    
    function animationLoop(ts){ 
      if (!TICKER.lastTime) TICKER.lastTime = ts; 
      var dt = ts - TICKER.lastTime; 
      TICKER.lastTime = ts; 
      
      var track = document.getElementById('ticker-track'); 
      var holder = document.getElementById('ticker');
      
      if (TICKER.text && track && holder && holder.style.display !== 'none'){ 
        TICKER.x -= (CONFIG.TICKER_SPEED * dt) / 1000; 
        if (TICKER.x + TICKER.w + TICKER.holderW < 0) TICKER.x = TICKER.holderW; 
        track.style.transform = 'translateX(' + Math.round(TICKER.x) + 'px)'; 
      } 
      
      TICKER.animFrame = requestAnimationFrame(animationLoop); 
    }
    
    window.addEventListener('resize', measureTicker);

    function signatureFromData(data){
      try{
        var raw = Array.isArray(data && data.events) ? data.events : [];
        var norm = raw.map(function(ev){
          return {
            t: ev.teams || ev.title || '',
            s: ev.start_time || ev.startTime || ev.start || ev.time || '',
            e: ev.end_time || ev.endTime || ev.end || '',
            r: ev.room || ev.location || ev.room_name || ''
          };
        });
        norm.sort(function(a, b){ 
          return String(a.s).localeCompare(String(b.s)); 
        });
        return JSON.stringify({
          title: data && data.rink_title || '',
          logo: data && data.rink_logo || '',
          tick: (data && (data.announcement || data.ticker_text)) || '',
          events: norm,
          theme: data && data.theme || null
        });
      } catch(e){ 
        return null; 
      }
    }
    
    function updateLiveProgressBars(){
      var bars = document.querySelectorAll('.progress[data-start] .progress-fill'); 
      var now = Date.now();
      var needsRefresh = false;
      
      for (var i = 0; i < bars.length; i++){ 
        var bar = bars[i];
        var holder = bar.parentElement; 
        var s = parseInt(holder.getAttribute('data-start'), 10);
        var e = parseInt(holder.getAttribute('data-end') || '0', 10); 
        
        if (!isNaN(s) && !isNaN(e) && e > s){ 
          var pct = Math.floor(((now - s) / (e - s)) * 100); 
          if (pct < 0) pct = 0; 
          if (pct > 100) {
            pct = 100;
            needsRefresh = true;
          }
          bar.style.width = pct + '%'; 
        } 
      }
      
      var eventRows = document.querySelectorAll('.event-row[data-end-time]');
      for (var j = 0; j < eventRows.length; j++) {
        var row = eventRows[j];
        var endTime = parseInt(row.getAttribute('data-end-time'), 10);
        if (endTime && now >= endTime) {
          needsRefresh = true;
          break;
        }
      }
      
      if (needsRefresh && state.lastPayload) {
        renderFromPayload(state.lastPayload);
      }
    }

    function renderFromPayload(data){
      var raw = (data && data.events) || [];
      var now = new Date();
      var title = (data && data.rink_title) || '';
      var logo = (data && data.rink_logo) || '';
      var ticker = (data && (data.announcement || data.ticker_text)) || '';
      
      if (data && data.registered) {
        setRegistrationStatus(true);
        state.lastSuccessfulData = data;
      }
      
      var events = [];
      
      for (var i = 0; i < raw.length; i++){
        var ev = raw[i] || {};
        var t = getEventTimes(ev);
        
        if (!t.start && !t.end) continue;
        if (t.end && now.getTime() >= t.end.getTime()) continue;
        
        ev.__start = t.start ? t.start.getTime() : Number.MAX_SAFE_INTEGER;
        ev.__times = t;
        events.push(ev);
      }
      
      events.sort(function(a, b){ 
        return a.__start - b.__start; 
      });
      
      if (events.length > 50) {
        events = events.slice(0, 50);
      }
      
      var titleEl = document.getElementById('rink-title');
      var headerLogo = document.getElementById('header-logo');
      if (titleEl) titleEl.textContent = title || 'Rink';
      if (headerLogo){ 
        if (logo){ 
          headerLogo.src = logo; 
          headerLogo.style.display = 'inline-block'; 
          headerLogo.onerror = function() {
            this.style.display = 'none';
          };
        } else { 
          headerLogo.removeAttribute('src'); 
          headerLogo.style.display = 'none'; 
        } 
      }
      
      var emptyLogo = document.getElementById('empty-logo');
      var emptyTitle = document.getElementById('empty-title');
      if (emptyTitle) {
        emptyTitle.textContent = title || '';
        emptyTitle.style.display = title ? 'block' : 'none';
      }
      if (emptyLogo){ 
        if (logo){ 
          emptyLogo.src = logo; 
          emptyLogo.style.display = 'inline-block'; 
          emptyLogo.onerror = function() {
            this.style.display = 'none';
          };
        } else { 
          emptyLogo.removeAttribute('src'); 
          emptyLogo.style.display = 'none'; 
        } 
      }
      
      updateTickerText(ticker);
      
      if (events && events.length){
        var html = '<div class="event-header">'
                 + '<div class="event-cell">Event</div>'
                 + '<div class="event-cell time">Time</div>'
                 + '<div class="event-cell room">Room</div>'
                 + '</div>';
        
        for (var j = 0; j < events.length; j++){
          var ev2 = events[j] || {};
          var teams = esc(ev2.teams || ev2.title || '');
          var startRaw = ev2.start_time || ev2.startTime || ev2.start || '';
          var endRaw = ev2.end_time || ev2.endTime || ev2.end || '';
          var room = esc(ev2.room || ev2.location || ev2.room_name || '');
          
          var timeStr = '';
          if (startRaw || endRaw){ 
            var a = to12h(startRaw);
            var b = to12h(endRaw); 
            timeStr = a && b ? (a + ' - ' + b) : (a || b); 
          } else if (ev2.time){ 
            timeStr = to12h(ev2.time); 
          }
          
          var start = ev2.__times.start;
          var end = ev2.__times.end;
          var isLive = false;
          var pct = null;
          var sMs = null;
          var eMs = null;
          
          if (start){
            var n = now.getTime();
            var s = start.getTime();
            var e = end ? end.getTime() : null;
            sMs = s; 
            eMs = e;
            
            if (n >= s && (e === null || n < e)){
              isLive = true;
              if (e !== null && e > s){
                pct = Math.floor(((n - s) / (e - s)) * 100);
                if (pct < 0) pct = 0; 
                if (pct > 100) pct = 100;
              }
            }
          }
          
          html += '<div class="event-row' + (isLive ? ' live' : '') + '" data-end-time="' + (eMs || '') + '">'
               +  '<div class="event-cell">' + teams + (isLive ? ' <span class="live-pill">LIVE</span>' : '') + '</div>'
               +  '<div class="event-cell time">' + (timeStr || '') + '</div>'
               +  '<div class="event-cell room">' + room + '</div>'
               +  '</div>';
          
          if (isLive && pct !== null){ 
            html += '<div class="progress" data-start="' + sMs + '" data-end="' + eMs + '">'
                 +  '<div class="progress-fill" style="width:' + pct + '%"></div></div>'; 
          }
        }
        
        var eventsEl = document.getElementById('events');
        if (eventsEl){ 
          eventsEl.innerHTML = html; 
          eventsEl.scrollTop = 0; 
          startAutoScroll(); 
        }
        
        hide('code-screen'); 
        show('header'); 
        show('event-screen'); 
        hide('empty-screen');
      } else {
        hide('code-screen'); 
        show('header'); 
        hide('event-screen'); 
        show('empty-screen'); 
        stopAutoScroll();
      }
    }
    
    function startAutoScroll(){
      var el = document.getElementById('events');
      if (!el) return;
      
      stopAutoScroll();
      
      if (el.scrollHeight <= el.clientHeight + 2){ 
        el.scrollTop = 0; 
        return; 
      }
      
      if (state.userInteracting) return;
      
      var step = CONFIG.SCROLL.SPEED;
      var interval = CONFIG.SCROLL.INTERVAL;
      var atBottomPause = CONFIG.SCROLL.PAUSE_BOTTOM;
      var atTopPause = CONFIG.SCROLL.PAUSE_TOP;
      var direction = 1;
      
      function begin(){ 
        state.scrollTimer = setInterval(tick, interval);
      }
      
      function tick(){
        var maxScroll = el.scrollHeight - el.clientHeight;
        el.scrollTop = el.scrollTop + step * direction;
        
        if (el.scrollTop >= maxScroll){
          el.scrollTop = maxScroll;
          clearInterval(state.scrollTimer);
          state.scrollTimer = null;
          state.scrollPause = setTimeout(function(){ 
            direction = -1; 
            begin(); 
          }, atBottomPause);
        } else if (el.scrollTop <= 0){
          el.scrollTop = 0;
          clearInterval(state.scrollTimer);
          state.scrollTimer = null;
          state.scrollPause = setTimeout(function(){ 
            direction = 1; 
            begin(); 
          }, atTopPause);
        }
      }
      
      state.scrollPause = setTimeout(begin, atTopPause);
    }
    
    function stopAutoScroll(){ 
      if (state.scrollTimer){ 
        clearInterval(state.scrollTimer); 
        state.scrollTimer = null; 
      } 
      if (state.scrollPause){ 
        clearTimeout(state.scrollPause); 
        state.scrollPause = null; 
      } 
    }
    
    function setupEventListeners() {
      var eventsContainer = document.getElementById('events');
      if (eventsContainer) {
        eventsContainer.addEventListener('mouseenter', function() {
          state.userInteracting = true;
          stopAutoScroll();
        });
        
        eventsContainer.addEventListener('mouseleave', function() {
          state.userInteracting = false;
          setTimeout(function() {
            if (!state.userInteracting) startAutoScroll();
          }, 2000);
        });
        
        eventsContainer.addEventListener('touchstart', function() {
          state.userInteracting = true;
          stopAutoScroll();
        });
        
        eventsContainer.addEventListener('touchend', function() {
          setTimeout(function() {
            state.userInteracting = false;
            if (!state.userInteracting) startAutoScroll();
          }, 5000);
        });
      }
    }
    
    function maybeRender(data){
      var sig = signatureFromData(data);
      
      state.lastPayload = data;
      
      if (data && data.theme) {
        applyTheme(data.theme);
        state.currentTheme = data.theme;
        setCacheWithExpiry('theme_' + state.screenCode, data.theme);
      }
      
      if (data && data.font_scale) {
        applyFontScale(data.font_scale);
      }
      
      if (data && data.rink_id && data.rink_id !== currentRinkId) {
        console.log('Rink ID changed, subscribing to realtime:', data.rink_id);
        subscribeToRealtime(data.rink_id);
      }
      
      if (sig && sig === state.lastSignature){ 
        updateLiveProgressBars(); 
        return; 
      }
      
      state.lastSignature = sig;
      setCacheWithExpiry('last_payload_' + state.screenCode, data);
      renderFromPayload(data);
    }
    
    async function checkScreenGroup(rinkId) {
      if (!supabaseClient || !rinkId) return null;

      try {
        // Check if this rink is part of an active group
        const { data: membership, error: memberError } = await supabaseClient
          .from('screen_group_members')
          .select(`
            id,
            is_master,
            group_id,
            screen_groups!inner (
              id,
              active
            )
          `)
          .eq('rink_id', rinkId)
          .eq('screen_groups.active', true)
          .single();

        if (memberError || !membership || membership.is_master) {
          // Not in a group, or is the master, so show own content
          return null;
        }

        // This screen is a follower - find the master
        const { data: master, error: masterError } = await supabaseClient
          .from('screen_group_members')
          .select(`
            rink_id,
            rinks!inner (
              id,
              screen_code
            )
          `)
          .eq('group_id', membership.group_id)
          .eq('is_master', true)
          .single();

        if (masterError || !master) {
          console.log('No master found for group');
          return null;
        }

        // Return the master's screen code
        return master.rinks.screen_code;
      } catch (e) {
        console.log('Error checking screen group:', e);
        return null;
      }
    }

    function checkAndLoadEvents(){
      if (isPreviewMode()) {
        return;
      }

      state.retryCount = 0;

      console.log('=== API CHECK ===');
      console.log('Current screen code:', state.screenCode);
      console.log('Stored in localStorage:', getLocal('screen_uuid'));
      console.log('API URL:', buildApiUrl());

      xhrGetWithRetry(
        buildApiUrl(),
        function(txt){
          var data = null;
          try{
            data = JSON.parse(txt);
          } catch(e){
            console.log('JSON parse error:', e);
          }

          console.log('=== API RESPONSE ===');
          console.log('Registered:', data && data.registered);
          console.log('Events count:', data && data.events ? data.events.length : 0);
          console.log('Rink title:', data && data.rink_title);
          
          // Check for API errors (503 database errors)
          if (data && data.error === 'database_error') {
            console.error('>>> DATABASE ERROR - Using cached data if available');
            // Try to use cached data
            var cache = getCacheWithExpiry('last_payload_' + state.screenCode);
            if (cache && cache.registered !== false) {
              maybeRender(cache);
              return;
            }
            // If no cache and was previously registered, show empty screen
            if (getRegistrationStatus() && state.lastSuccessfulData) {
              maybeRender({
                registered: true,
                rink_title: state.lastSuccessfulData.rink_title || '',
                rink_logo: state.lastSuccessfulData.rink_logo || '',
                ticker_text: state.lastSuccessfulData.ticker_text || '',
                events: [],
                theme: state.currentTheme
              });
              return;
            }
            // Otherwise show code screen
            show('code-screen');
            hide('header');
            hide('event-screen');
            hide('empty-screen');
            stopAutoScroll();
            return;
          }
          
          if (!data || data.registered === false) {
            console.log('>>> SHOWING CODE SCREEN (not registered)');
            setRegistrationStatus(false);
            show('code-screen');
            hide('header');
            hide('event-screen');
            hide('empty-screen');
            stopAutoScroll();
            return;
          }

          // Check if this screen is part of a group and should mirror master
          if (data && data.rink_id) {
            checkScreenGroup(data.rink_id).then(function(masterScreenCode) {
              if (masterScreenCode && masterScreenCode !== state.screenCode) {
                console.log('>>> SCREEN IS IN GROUP - Loading master content from:', masterScreenCode);
                // Load master's content instead
                var masterUrl = 'https://post-signage-api.abdullaafraz.workers.dev?id=' +
                               encodeURIComponent(masterScreenCode);
                xhrGetWithRetry(
                  masterUrl,
                  function(masterTxt) {
                    try {
                      var masterData = JSON.parse(masterTxt);
                      if (masterData && masterData.registered) {
                        console.log('>>> RENDERING MASTER CONTENT');
                        maybeRender(masterData);
                      } else {
                        console.log('>>> MASTER NOT REGISTERED - Showing own content');
                        maybeRender(data);
                      }
                    } catch(e) {
                      console.log('>>> ERROR LOADING MASTER - Showing own content');
                      maybeRender(data);
                    }
                  },
                  function(error) {
                    console.log('>>> FAILED TO LOAD MASTER - Showing own content');
                    maybeRender(data);
                  }
                );
              } else {
                // Check for combined display layout (fetch settings from DB)
                checkAndLoadCombinedIfNeeded(data).then(function(success) {
                  if (!success) {
                    console.log('>>> RENDERING EVENTS (registered)');
                    document.body.classList.remove('combined-mode');
                    var combinedContainer = document.getElementById('combined-display');
                    if (combinedContainer) combinedContainer.className = '';
                    maybeRender(data);
                  }
                }).catch(function(error) {
                  console.log('>>> COMBINED DISPLAY ERROR - Showing single rink');
                  document.body.classList.remove('combined-mode');
                  maybeRender(data);
                });
              }
            }).catch(function(error) {
              console.log('>>> ERROR CHECKING GROUP - Showing own content');
              maybeRender(data);
            });
          } else {
            // Check for combined display layout (fetch settings from DB)
            checkAndLoadCombinedIfNeeded(data).then(function(success) {
              if (!success) {
                console.log('>>> RENDERING EVENTS (registered)');
                document.body.classList.remove('combined-mode');
                var combinedContainer = document.getElementById('combined-display');
                if (combinedContainer) combinedContainer.className = '';
                maybeRender(data);
              }
            }).catch(function(error) {
              console.log('>>> COMBINED DISPLAY ERROR - Showing single rink');
              document.body.classList.remove('combined-mode');
              maybeRender(data);
            });
          }
        }, 
        function(error){
          console.log('API call failed:', error);
          
          var cache = getCacheWithExpiry('last_payload_' + state.screenCode);
          if (cache && cache.registered !== false) {
            maybeRender(cache);
            return;
          }
          
          if (getRegistrationStatus() && state.lastSuccessfulData) {
            maybeRender({
              registered: true,
              rink_title: state.lastSuccessfulData.rink_title || '',
              rink_logo: state.lastSuccessfulData.rink_logo || '',
              ticker_text: state.lastSuccessfulData.ticker_text || '',
              events: [],
              theme: state.currentTheme
            });
            return;
          }
          
          show('code-screen'); 
          hide('header'); 
          hide('event-screen'); 
          hide('empty-screen'); 
          stopAutoScroll();
        }
      );
    }
    
    function scheduleNightlyRefresh() {
      var now = new Date();
      var tomorrow = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, 3, 0, 0, 0);
      var msUntilRefresh = tomorrow.getTime() - now.getTime();
      
      setTimeout(function() {
        location.reload(true);
      }, msUntilRefresh);
    }
    
    window.addEventListener('beforeunload', function() {
      stopAutoScroll();
      if (state.pollHandle) clearInterval(state.pollHandle);
      if (TICKER.animFrame) cancelAnimationFrame(TICKER.animFrame);
      if (realtimeChannel && supabaseClient) {
        supabaseClient.removeChannel(realtimeChannel);
      }
    });
    
    function checkEventStatus() {
      if (!state.lastPayload || !state.lastPayload.events) return;
      
      var now = new Date();
      var needsRerender = false;
      
      var events = state.lastPayload.events || [];
      for (var i = 0; i < events.length; i++) {
        var ev = events[i];
        var times = getEventTimes(ev);
        
        if (!times.start || !times.end) continue;
        
        var startTime = times.start.getTime();
        var endTime = times.end.getTime();
        var nowTime = now.getTime();
        
        var wasLive = ev.__wasLive || false;
        var isLiveNow = (nowTime >= startTime && nowTime < endTime);
        var isExpired = (nowTime >= endTime);
        
        if (isExpired && !ev.__expired) {
          needsRerender = true;
          ev.__expired = true;
        } else if (!wasLive && isLiveNow) {
          needsRerender = true;
          ev.__wasLive = true;
        }
      }
      
      if (needsRerender) {
        renderFromPayload(state.lastPayload);
      }

      // Also update combined display if active
      if (state.combinedLayout && state.combinedRinks && state.combinedRinks.length > 0) {
        updateCombinedDisplay();
      }
    }
    
    detectPlatform();
    state.screenCode = getOrCreateScreenCode();
    state.isRegistered = getRegistrationStatus();
    
    console.log('==== INITIALIZATION ====');
    console.log('Screen code set to:', state.screenCode);
    console.log('Stored in localStorage:', getLocal('screen_uuid'));
    console.log('Registration status:', state.isRegistered);
    
    initSupabase();
    
    loadCachedTheme();
    
    if (isPreviewMode()) {
      applyPreviewTheme();
    } else {
      var codeEl = document.getElementById('screen-code'); 
      if (codeEl) codeEl.textContent = state.screenCode;
      
      // Simple heartbeat - only on actual screens (not preview)
      // Simple heartbeat - TV-compatible (uses XMLHttpRequest)
      function sendHeartbeat() {
        if (!state.screenCode) return;
        
        try {
          var xhr = new XMLHttpRequest();
          var url = buildApiUrl() + '&health=1';
          var payload = JSON.stringify({
            screen_code: state.screenCode,
            timestamp: new Date().toISOString(),
            event_type: 'heartbeat'
          });
          
          xhr.open('POST', url, true);
          xhr.setRequestHeader('Content-Type', 'application/json');
          xhr.timeout = 5000; // 5 second timeout
          
          xhr.onload = function() {
            if (xhr.status >= 200 && xhr.status < 300) {
              console.log('‚úì Heartbeat sent successfully');
            }
          };
          
          xhr.onerror = function() {
            console.log('‚úó Heartbeat failed (network error)');
          };
          
          xhr.ontimeout = function() {
            console.log('‚úó Heartbeat timeout');
          };
          
          xhr.send(payload);
        } catch(e) {
          console.log('‚úó Heartbeat error:', e);
        }
      }
      
      // Send heartbeat every 30 seconds
      sendHeartbeat(); // Immediate first ping
      setInterval(sendHeartbeat, CONFIG.HEARTBEAT_INTERVAL);
      
      updateClock(); 
      setInterval(updateClock, 10000);
      setInterval(updateLiveProgressBars, CONFIG.PROGRESS_UPDATE_INTERVAL);
      
      setInterval(checkEventStatus, 1000);
      
      setTimeout(setupEventListeners, 100);
      
      checkAndLoadEvents(); 
      if (state.pollHandle) clearInterval(state.pollHandle);
      state.pollHandle = setInterval(checkAndLoadEvents, CONFIG.POLL_INTERVAL);
      
      scheduleNightlyRefresh();
    }
    
    animationLoop(performance.now());
  })();
  </script>
</body>
</html>
